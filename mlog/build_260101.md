# Docker Build Log - OCR RAG Base Image

**Date:** 2026-01-01
**Image:** `ocr-rag:base`
**Base Image:** `nvidia/cuda:12.9.1-runtime-ubuntu24.04`
**Status:** ✅ SUCCESS

---

## Final Configuration

### System Components
| Component | Version |
|-----------|---------|
| CUDA | 12.9.1 |
| Python | 3.12.3 (system) |
| uv (package manager) | 0.9.21 |

### Deep Learning Frameworks
| Package | Version | Notes |
|---------|---------|-------|
| torch | 2.7.1+cu128 | CUDA 12.8 → backward compatible with 12.9.1 |
| torchvision | 0.22.1+cu128 | Fixed from 0.18.1 |
| torchaudio | 2.7.1+cu128 | Fixed from 2.8.1 |
| paddlepaddle-gpu | 2.6.2 | Latest 2.6.x |

### OCR Engines
| Package | Version | Notes |
|---------|---------|-------|
| paddleocr | 3.3.2 | Updated from 2.7.0.3 |
| yomitoku | 0.9.5 | Latest available |
| tesseract-ocr | 5.3.4 | With Japanese (jpn, jpn-vert) |
| pymupdf | 1.24.12 | For PDF processing |

### NLP & RAG
| Package | Version |
|---------|---------|
| transformers | 4.36.0 |
| accelerate | 0.26.0 |
| langchain | 0.1.0 |
| langchain-community | 0.0.10 |
| llama-index | 0.9.0 |
| pymilvus | 2.4.0 |

### Image Processing
| Package | Version |
|---------|---------|
| opencv-python | 4.10.0.84 |
| opencv-contrib-python | 4.10.0.84 |
| pillow | 10.0.0 |
| numpy | 1.26.4 |

### ML Utilities
| Package | Version |
|---------|---------|
| scipy | 1.14.1 |
| scikit-learn | 1.5.2 |
| pandas | 2.0.3 |

### Configuration
| Package | Version |
|---------|---------|
| pydantic | 2.10.4 |
| pyyaml | 6.0.2 |
| huggingface-hub | 0.26.5 |

### Models Baked into Image
| Model | Location | Size |
|-------|----------|------|
| Sarashina Embedding v1-1b | `/app/models/sarashina/` | ~1.1GB |

---

## Issues Encountered and Resolved

### 1. Python Version Compatibility
**Error:** PyTorch 2.7.1+cu128 wheels not available for Python 3.14 (uv's default)
**Solution:** Explicitly specify `uv venv --python 3.12`

### 2. PyTorch Version Mismatch
**Error:** `torchvision==0.18.1` and `torchaudio==2.8.1` incompatible with `torch==2.7.1`
**Solution:** Updated to `torchvision==0.22.1` and `torchaudio==2.7.1`

### 3. opencv-python Version Conflict
**Error:** `paddleocr==2.7.0.3` requires `opencv-python<=4.6.0.66`, `yomitoku==0.9.5` requires `>=4.10.0.84`
**Solution:** Updated to `paddleocr==3.3.2` (supports newer opencv) and `opencv-python==4.10.0.84`

### 4. numpy Version Incompatibility
**Error:** `opencv-python==4.10.0.84` requires `numpy>=1.26.0`, had `numpy==1.24.3`
**Solution:** Updated to `numpy==1.26.4`

### 5. pydantic Version Requirement
**Error:** `yomitoku==0.9.5` requires `pydantic>=2.9.2`, had `pydantic==2.0.2`
**Solution:** Updated to `pydantic==2.10.4`

### 6. huggingface-hub Version Requirement
**Error:** `yomitoku==0.9.5` requires `huggingface-hub>=0.26.1`, had `0.19.4`
**Solution:** Updated to `huggingface-hub==0.26.5`

### 7. pymupdf Version Conflict
**Error:** `paddleocr==3.3.2` requires `pymupdf<1.24.0`, had `pymupdf==1.23.0`
**Solution:** Updated to `pymupdf==1.24.12`

### 8. pyyaml Version Requirement
**Error:** `paddleocr==3.3.2` requires `pyyaml==6.0.2`, had `pyyaml==6.0.1`
**Solution:** Updated to `pyyaml==6.0.2`

### 9. Network Timeout
**Error:** `Failed to download nvidia-nvtx-cu12==12.8.55` due to 30s timeout
**Solution:** Set `UV_HTTP_TIMEOUT=600`

### 10. scipy Build from Source Failure
**Error:** `scipy==1.11.0` failed to build (missing OpenBLAS, Fortran compiler)
**Solution:** Updated to `scipy==1.14.1` (has Python 3.12 wheels)

### 11. Missing Build Dependencies
**Error:** scipy/numpy build needed `gfortran`, `pkg-config`, `libopenblas-dev`
**Solution:** Added build dependencies in builder stage

### 12. Missing git in Base Stage
**Error:** `/bin/sh: git: not found` when cloning model
**Solution:** Added `git` to base stage runtime dependencies

### 13. UID Conflict
**Error:** `useradd: UID 1000 is not unique`
**Solution:** Changed to UID 1001 and added existence check: `id -u appuser 2>/dev/null || useradd -m -u 1001 appuser`

---

## Dockerfile Structure

### Multi-Stage Build

**Stage 1: Builder**
- Installs build tools: build-essential, gcc, g++, gfortran, cmake, pkg-config
- Installs development libraries: libopenblas-dev, liblapack-dev
- Creates Python 3.12 venv with uv
- Installs all Python packages with `--index-strategy unsafe-best-match`

**Stage 2: Base**
- Runtime dependencies only (no build tools)
- Copies venv from builder
- Downloads Sarashina model
- Creates non-root user (UID 1001)

### Environment Variables
```dockerfile
UV_CACHE_DIR=/tmp/uv-cache
UV_HTTP_TIMEOUT=600
CUDA_HOME=/usr/local/cuda
PATH=/usr/local/cuda/bin:/app/.venv/bin:$PATH
LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
PYTHONPATH=/app
```

---

## Build Statistics

| Metric | Value |
|--------|-------|
| Total Build Time | ~12 minutes |
| Packages Installed | 163 |
| venv Size | ~20 GB (before layer compression) |
| Final Image Size | ~15 GB (estimated) |
| Build Cache Used | Yes (Docker layer caching) |

---

## Usage

### Build Command
```bash
docker build -f Dockerfile.base -t ocr-rag:base .
```

### Run Container
```bash
docker run --gpus all -it --rm ocr-rag:base /bin/bash
```

### Verify Installation
```bash
# Inside container
python -c "import torch; print(f'PyTorch: {torch.__version__}, CUDA: {torch.cuda.is_available()}')"
python -c "import paddleocr; print('PaddleOCR:', paddleocr.__version__)"
python -c "import yomitoku; print('YomiToku:', yomitoku.__version__)"
```

---

## Next Steps

1. Build `Dockerfile.app` using this base image
2. Test GPU functionality with `nvidia-smi`
3. Verify OCR engines work with Japanese text
4. Test model inference performance

---

## Files Modified

- `Dockerfile.base` - Multi-stage build with venv copy
- `requirements-base.txt` - Updated package versions for compatibility

---

## Build Output (Last Layer)

```
#19 exporting to image
#19 exporting layers 266.4s done
#19 exporting manifest sha256:c38a9663909603c7965521743d4a966006c4a41e048dd763ac5333d31716c101 done
#19 exporting config sha256:d16446e0ed4d7d9a28c4fc584e6c5002758040470b294afe789e4e1e5d145dae done
#19 exporting attestation manifest sha256:dda614383c96bb8c3ecbe5d276658d21295fe7ecdb67a887e3504fba6e00ccd9 0.0s done
#19 exporting manifest list sha256:7970a9f11ea50d09f9394d295fd2046357aa7aee68c639480118b4d6cadb27ff done
#19 naming to docker.io/library/ocr-rag:base done
#19 unpacking to docker.io/library/ocr-rag:base 103.8s done
#19 DONE 370.3s
```
