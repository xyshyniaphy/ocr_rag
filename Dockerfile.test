# ========================================
# Dockerfile.test
# Test image - Based on ocr-rag:app
# Inherits all app dependencies and adds test requirements
# ========================================

FROM ocr-rag-app:dev

# ========================================
# Install test dependencies only
# Test files and results are mounted as volumes
# ========================================

# Switch to root for installation
USER root

# Set working directory
WORKDIR /app

# Install uv (fast Python package installer) if not already installed
RUN which uv || (curl -LsSf https://astral.sh/uv/install.sh | sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv)

# Copy test requirements
COPY requirements-test.txt /app/

# Install test dependencies
RUN uv pip install --no-cache-dir -r requirements-test.txt

# ========================================
# Final configuration
# ========================================

# Switch to non-root user
USER appuser

# Set test environment variables
ENV PYTEST_ADDOPTS="-v"

# Default command - run pytest
# Can be overridden with docker run/test.sh arguments
CMD ["pytest", "tests/", "-v", "--tb=short"]
