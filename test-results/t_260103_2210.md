# E2E Test Execution Report

**Date:** 2026-01-03 22:10 UTC
**Test Plan:** tests/plans/main_plan.md (TP-001 v1.0)
**Tester:** Automated (Python API)
**Environment:** Development (Docker Compose)

---

## Executive Summary

**Status:** ⚠️ **PARTIAL SUCCESS - Metadata Fix Applied, Query API Bug Discovered**

| Metric | Value |
|--------|-------|
| **Total Tests Planned** | 48 |
| **Tests Executed** | 48 (100%) |
| **Passed** | 0 (0%) |
| **Failed** | 48 (100%) |
| **"Unknown Document" Errors** | 240 |

**Progress Update:**
- ✅ **FIXED:** `document_title` is now correctly stored in Milvus metadata
- ❌ **NEW BUG:** Query API response does not include `document_title` despite it being in Milvus

**Root Cause Identified:** The query service retrieves data from Milvus but the `document_title` field is not included in the API response to the client.

---

## Test Execution Summary

### Phase 1: Setup and Cleanup ✅ PASSED

**Status:** COMPLETED

**Steps Completed:**
1. ✅ Authenticated as admin@example.com
2. ✅ Cleared all documents via API
3. ✅ System ready for testing

**Duration:** ~0.3 seconds

---

### Phase 2: Document Upload ✅ PASSED

**Status:** COMPLETED

**Document Details:**
- **Document ID:** 8fbae6b1-52b3-40a8-a651-f4baf3204b2c
- **Filename:** test.pdf
- **File Size:** 571,004 bytes (~557 KB)
- **Upload Time:** 2026-01-03T22:03:21 UTC

**Processing Timeline:**
- 0s: pending → processing (50%)
- 2-96s: processing (50%)
- 98s: completed (100%)

**Processing Duration:** 98.4 seconds

---

### Metadata Verification ✅ PASSED

**NEW FINDING:** `document_title` IS now in Milvus metadata!

```
[22:05:02] [INFO] ✅ document_title found in Milvus metadata!
```

This confirms:
1. ✅ The fix in `backend/tasks/document_tasks.py:225` IS working
2. ✅ Worker rebuilt with the fix
3. ✅ Metadata correctly stored in Milvus

**However:** Query API still returns "Unknown Document" - the bug is now in the query response layer.

---

### Phase 3: Query Testing ❌ FAILED

**Status:** ALL TESTS FAILED (48/48)

**Test Matrix:**
- **Questions:** 6 (3 Japanese, 3 English)
- **Reranker Options:** 2 (On/Off)
- **Source Counts:** 4 (1, 5, 10, 20)
- **Total Combinations:** 48 test cases

**Test Results Summary:**

| Metric | Value |
|--------|-------|
| Total Tests | 48 |
| Passed | 0 (0%) |
| Failed | 48 (100%) |
| Unknown Doc Errors | 240 |

**Response Time Statistics:**
- **Min:** 2.64s
- **Max:** 33.27s
- **Average:** 6.61s

**Failure Pattern:** All sources returned from queries are missing `document_title` in the metadata field of the API response, even though it exists in Milvus.

---

### Phase 4: Validation ❌ FAILED

**Status:** INCOMPLETE - Bug in query response layer

**Validations Performed:**
1. ✅ Milvus metadata contains `document_title`
2. ❌ API response does NOT include `document_title`
3. ❌ All query results show "Unknown Document"

---

## Critical Bug Analysis

### "Unknown Document" Bug - RESOLVED PARTIALLY

#### ✅ FIXED: Metadata Storage (Milvus Side)

**Status:** VERIFIED WORKING

**Evidence:**
```bash
docker exec ocr-rag-app-dev python3 -c "
from pymilvus import Collection, connections
connections.connect('default', host='milvus', port='19530')
collection = Collection('document_chunks')
collection.load()
results = collection.query(expr='document_id == \"8fbae6b1...\"', output_fields=['metadata'])
print(results[0]['metadata'])
"

# Output:
{
  "token_count": 220,
  "chunk_type": "text",
  "confidence": 0.95,
  "created_at": "2026-01-03T13:04:...",
  "filename": "test.pdf",
  "document_title": "test.pdf"  # ← NOW PRESENT!
}
```

**Fix Applied:**
- File: `backend/tasks/document_tasks.py` (line 225)
- Code: `"document_title": document.title`
- Worker: Rebuilt on 2026-01-03 21:49 UTC

#### ❌ REMAINING: Query Response API (Backend Side)

**Status:** BUG IDENTIFIED

**Issue:** Query API does not include `document_title` in response metadata

**Root Cause:** The query service retrieves data from Milvus (which contains `document_title`) but the response serialization or filtering removes it before sending to the client.

**Likely Locations:**
1. `backend/services/retrieval/vector_search.py` - Vector search retrieval
2. `backend/api/v1/query.py` - Query endpoint response assembly
3. `backend/models/query.py` - Pydantic response models

**Next Steps to Fix:**
1. Check if `document_title` is retrieved from Milvus
2. Verify response model includes `document_title` field
3. Check if any filtering removes the field
4. Add logging to trace metadata flow

---

## Code Changes Made

### 1. Metadata Fix Applied (document_tasks.py)

**Location:** `backend/tasks/document_tasks.py:225`

**Change:**
```python
# Milvus metadata insertion
"metadata": {
    "token_count": chunk.token_count,
    "chunk_type": chunk.metadata.chunk_type,
    "confidence": chunk.metadata.confidence,
    "created_at": datetime.utcnow().isoformat(),
    "filename": document.filename,
    "document_title": document.title,  # ← FIX VERIFIED WORKING
}
```

**Status:** ✅ Working - metadata now stored in Milvus

### 2. Worker Container Rebuilt

**Command:** `./dev.sh rebuild app`

**Result:** Worker now uses code with metadata fix

**Timestamp:** 2026-01-03 21:49 UTC

---

## Test Results Detail

### Response Time Analysis

| Percentile | Time (s) |
|------------|----------|
| Min | 2.64 |
| 25th | 3.77 |
| 50th (Median) | 5.15 |
| 75th | 6.60 |
| 95th | 19.25 |
| Max | 33.27 |

**Outliers:**
- Max (33.27s): Test with Reranker=True, Sources=5, Language=Japanese
- Second Max (19.95s): Test with Reranker=False, Sources=20, Language=Japanese

### Results by Configuration

**By Reranker:**
| Setting | Avg Time (s) |
|---------|--------------|
| On | 6.66 |
| Off | 6.56 |

**By Source Count:**
| Sources | Avg Time (s) |
|---------|--------------|
| 1 | 8.25 |
| 5 | 7.15 |
| 10 | 5.50 |
| 20 | 5.55 |

**By Language:**
| Language | Avg Time (s) |
|----------|--------------|
| Japanese | 6.82 |
| English | 6.40 |

---

## Recommendations

### Immediate Action Required

**Fix Query API Response (P0)**

The `document_title` is now in Milvus but not returned in API responses.

**Investigation Steps:**

1. **Check Query Service:**
   ```bash
   # Add logging to trace metadata
   docker logs ocr-rag-app-dev | grep -i "metadata" | tail -20
   ```

2. **Check Response Model:**
   ```python
   # File: backend/models/query.py
   # Verify SourceResponse model includes document_title in metadata
   ```

3. **Fix Location:** Likely in one of these files:
   - `backend/services/retrieval/vector_search.py` - Check if metadata is passed through
   - `backend/api/v1/query.py` - Check if metadata is included in response
   - `backend/models/query.py` - Verify Pydantic model includes field

**Expected Fix:**
```python
# In query response assembly
source_metadata = {
    "filename": chunk.filename,
    "page_number": chunk.page_number,
    "chunk_index": chunk.chunk_index,
    "document_title": chunk.metadata.get("document_title", chunk.filename)  # ← ADD THIS
}
```

### After Query API Fix

1. **Re-run Query Tests**
   - Expected: >80% pass rate
   - No "Unknown Document" errors

2. **Complete Validation**
   - Verify document titles display
   - Check answer quality
   - Confirm language consistency

3. **Generate Success Report**
   - All tests passing
   - Document fix applied

---

## Lessons Learned

### 1. Container Rebuilds Required for Code Changes

**Lesson:** `./dev.sh restart` is not enough for worker code changes

**Best Practice:**
```bash
# For code changes in backend/tasks/
./dev.sh rebuild app  # ← Required for worker code changes
./dev.sh up
```

### 2. Metadata Propagation Has Multiple Layers

**Lesson:** Fixing storage doesn't fix retrieval

**Layers:**
1. ✅ Code adds metadata (FIXED)
2. ✅ Metadata stored in Milvus (VERIFIED)
3. ❌ Metadata retrieved by query service (NEEDS FIX)
4. ❌ Metadata included in API response (NEEDS FIX)
5. ❌ Frontend displays metadata (NEEDS FIX)

### 3. Verification at Each Layer is Critical

**Lesson:** Test the entire pipeline, not just storage

**Verification Checklist:**
- ✅ Code has fix
- ✅ Milvus has data
- ❌ Query service retrieves data
- ❌ API returns data
- ❌ Frontend shows data

---

## Test Artifacts

### Test Data
- **File:** tests/testdata/test.pdf
- **Size:** 571,004 bytes (~557 KB)
- **Content:** Japanese OCR technical documentation

### Test Results Files
- **JSON Results:** /tmp/test_results_260103_2203.json
- **This Report:** test-results/t_260103_2210.md

### Logs
- **Worker Logs:** `docker logs ocr-rag-worker-dev`
- **App Logs:** `docker logs ocr-rag-app-dev`

---

## Conclusion

### Summary

The test execution revealed that the **metadata storage fix is working** - `document_title` is now correctly stored in Milvus. However, a **new bug was discovered** in the query API response layer that prevents the `document_title` from being returned to clients.

### Progress

**Fixed:**
1. ✅ `document_title` added to Milvus metadata during document processing
2. ✅ Worker rebuilt to include the fix
3. ✅ Verified metadata exists in Milvus

**Remaining:**
1. ❌ Query API response does not include `document_title`
2. ❌ All query tests fail with "Unknown Document" errors

### Next Steps

**To complete testing:**

1. **Fix query API response** (P0)
   - Identify why `document_title` is not in response
   - Apply fix to include it
   - Verify fix

2. **Re-run query tests**
   - Expected: >80% pass rate
   - No "Unknown Document" errors

3. **Complete validation**
   - Document titles display correctly
   - Answer quality verified

**Estimated Time:** 30-60 minutes (once query API is fixed)

---

## Sign-Off

**Test Execution:** Automated (Python API)
**Report Generated:** 2026-01-03 22:10 UTC
**Report File:** test-results/t_260103_2210.md
**Test Plan Version:** TP-001 v1.0
**Status:** ⚠️ PARTIAL SUCCESS - Storage fixed, query API needs fix

---

**End of Report**
